import os
import requests
import time
import json
from typing import Dict, Any, List
from enum import Enum
import datetime

# langchain
from langchain.prompts import PromptTemplate


################################################
# (A) State/Step êµ¬ì¡° & ë³€ìˆ˜ ì„¤ëª…
################################################

class ChatbotState(Enum):
    THERAPEUTIC_CONNECTION = "Therapeutic_Connection"
    MUSIC_CREATION = "Music_Creation"
    MUSIC_DISCUSSION = "Music_Discussion"
    WRAP_UP = "Wrap_Up"

# [ì˜ˆì‹œ] ê° ìŠ¤í…ì—ì„œ í•„ìš”í•œ ë³€ìˆ˜ë¥¼ "ì„¤ëª…"ê³¼ í•¨ê»˜ ì •ì˜
# ì‹¤ì œë¡œëŠ” í•œêµ­ì–´ ì„¤ëª…ì„ ë¶™ì´ê±°ë‚˜, ë³€ìˆ˜ëª…ì„ ë” ë‹¤ì–‘í•˜ê²Œ êµ¬ì„±í•˜ì‹œë©´ ë©ë‹ˆë‹¤.
STEP_VAR_DESCRIPTIONS = {
    # 1) Therapeutic_Connection
    ChatbotState.THERAPEUTIC_CONNECTION.value: {
        "rapport_building": {
            "user_ready": "ì‚¬ìš©ìì˜ ìŒì•…ë§Œë“¤ê¸°ì— ëŒ€í•œ ê´€ì‹¬ ì—¬ë¶€"
        },
        "goal_and_motivation_building": {
            "motivation": "ì‚¬ìš©ìê°€ ìŒì•…ë§Œë“¤ê¸° í™œë™ì„ í†µí•´ ë‹¬ì„±í•˜ê³  ì‹¶ì€ ëª©í‘œ",
            "difficulty": "ì‚¬ìš©ìê°€ í˜„ì¬ ê²ªê³  ìˆëŠ” ì–´ë ¤ì›€, ì–´ë ¤ì›€ìœ¼ë¡œ ì•¼ê¸°ë˜ëŠ” ë¬¸ì œì ",
            "emotion": "ì‚¬ìš©ìê°€ ìµœê·¼ ë“¤ì–´ ë§ì´ ëŠë¼ëŠ” ê°ì •"
        },
        "music_preference": {
            "music_info": "ì‚¬ìš©ìê°€ ì¢‹ì•„í•˜ê±°ë‚˜ ê´€ì‹¬ìˆê±°ë‚˜ ì‹«ì–´í•˜ëŠ” ìŒì•… ì •ë³´ (ì¥ë¥´, ìŠ¤íƒ€ì¼ ë“±)"
        },
    },

    # 2) Music_Creation
    ChatbotState.MUSIC_CREATION.value: {
        "making_concept": {
            "concept": "ìŒì•…ì˜ ì „ë°˜ì ì¸ ì»¨ì…‰ (ë¶„ìœ„ê¸°, í…Œë§ˆ, ë©”ì‹œì§€ ë“±)"
        },
        "making_lyrics": {
            "lyrics_keyword": "ê°€ì‚¬ì— ë“¤ì–´ê°ˆ í•µì‹¬ í‚¤ì›Œë“œ ë˜ëŠ” ì•„ì´ë””ì–´",
            "lyrics_sentence":"ê°€ì‚¬ì˜ í•µì‹¬ ë¬¸ì¥",
            "lyrics_flow": "ê°€ì‚¬ì˜ íë¦„",
        },
        "lyrics_gen":{
            "lyrics": "ìƒì„±ëœ ìµœì¢… ê°€ì‚¬"
        },
        "lyrics_discussion": {
            "discussion_feedback": "ê°€ì‚¬ì— ëŒ€í•œ ì‚¬ìš©ì ì˜ê²¬"
        },
        "making_music": {
            "title": "ì‚¬ìš©ìê°€ ë§Œë“¤ ë…¸ë˜ ì œëª©",
            "music_component": "ë©œë¡œë””, ì½”ë“œ ì§„í–‰, ë¦¬ë“¬ ë“± êµ¬ì²´ì ì¸ ìŒì•… ì•„ì´ë””ì–´",
            
        },
        "style_gen":{
            "style_prompt":"ì±—ë´‡ì´ ë§Œë“¤ì–´ì¤€ ë…¸ë˜ êµ¬ì„±ìš”ì†Œ í”„ë¡¬í”„íŠ¸"
        }
    },

    # 3) Music_Discussion
    ChatbotState.MUSIC_DISCUSSION.value: {
        "music_opinion": {
            "individual_emotion": "ì‚¬ìš©ìê°€ ìŒì•…ì„ ë“£ê³  ëŠë‚€ ê°œì¸ì  ê°ì •",
            "strength": "ìŒì•…ë§Œë“¤ê¸° í™œë™ì„ í†µí•´ ëŠë‚€ ì‚¬ìš©ìì˜ ì¥ì "
        },
        "music_recreation": {
            "change_music": "ì‚¬ìš©ìê°€ ë°”ê¾¸ê³  ì‹¶ê±°ë‚˜ ê°œì„ í•˜ê³  ì‹¶ì€ ìŒì•… ìš”ì†Œ"
        },
    },

    # 4) Wrap_Up
    ChatbotState.WRAP_UP.value: {
        "reflection": {
            "change_mind": "ì „ì²´ ê³¼ì •ì„ í†µí•´ ì‚¬ìš©ìì—ê²Œ ìƒê¸´ ì‹¬ê²½ ë³€í™”ë‚˜ ì¸ì‚¬ì´íŠ¸"
        },
        "complete": {
            "feeling": "ìŒì•… ë§Œë“¤ê¸° í™œë™ì„ í†µí•´ì„œ ì‚¬ìš©ìê°€ ëŠë‚€ ë¶€ë¶„"
        },
    },
}

# (ìŠ¤í…ë³„ ë©”ì¸ ëŒ€í™” í”„ë¡¬í”„íŠ¸: ì‹¤ì œë¡œëŠ” ë” í’ë¶€í•˜ê²Œ ì‘ì„± ê°€ëŠ¥)
STEP_MAIN_PROMPTS = {
    ChatbotState.THERAPEUTIC_CONNECTION.value: {
        "rapport_building": """
            [ë¼í¬ í˜•ì„±] 
            ìˆœì„œëŒ€ë¡œ ì§„í–‰í•˜ì„¸ìš”. ë˜ë„ë¡ ì§§ê²Œ ì§ˆë¬¸ì„ ì§„í–‰í•˜ì„¸ìš”. 
            1. ì‚¬ìš©ìì™€ ë¼í¬ë¥¼ ìŒ“ê¸° ìœ„í•´ì„œ ì•„ì´ìŠ¤ë¸Œë ˆì´í‚¹ì„ ì§„í–‰í•˜ì„¸ìš”.
                - ì˜¤ëŠ˜ í•˜ë£¨ ì–´ë• ë‚˜ìš”?
            2. ì‚¬ìš©ìê°€ ìŒì•… ë§Œë“¤ê¸°ì— ëŒ€í•´ ê´€ì‹¬ì´ ìˆëŠ”ì§€ ë¬¼ì–´ë³´ê³  ì•ìœ¼ë¡œì˜ ìŒì•…ë§Œë“¤ê¸° ê³¼ì •ì„ ê²©ë ¤í•˜ì„¸ìš”.
                 - ë°˜ê°‘ìŠµë‹ˆë‹¤, Nameë‹˜. ì˜¤ëŠ˜ ì €ì™€ í•¨ê»˜ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ„ê³ , ê·¸ ì´ì•¼ê¸°ë¥¼ ìŒì•…ìœ¼ë¡œ í‘œí˜„í•´ë³´ë©´ ì–´ë–¨ê¹Œìš”? Nameë‹˜ì˜ ìƒê°ê³¼ ë§ˆìŒì„ ë‹´ì•„ë³´ëŠ” ë° ì œê°€ ì¡°ê¸ˆì´ë‚˜ë§ˆ ë„ì›€ì„ ë“œë¦´ ìˆ˜ ìˆìœ¼ë©´ ì¢‹ê² ì–´ìš”.
                - ìŒì•…ì„ ë§Œë“ ë‹¤ëŠ” ê²Œ ì–´ë ¤ì›Œë³´ì¼ ìˆ˜ ìˆì§€ë§Œ, Nameë‹˜ì´ ë„ì™€ì¤€ë‹¤ë©´ ê°™ì´ ë©‹ì§„ ìŒì•…ì„ ë§Œë“¤ ìˆ˜ ìˆì„ ê²ƒ ê°™ì•„ìš”. ì €ì™€ í•¨ê»˜ ì˜¤ëŠ˜ì˜ ìŒì•…ì„ ë§Œë“¤ì–´ ë³¼ ì¤€ë¹„ê°€ ë˜ì…¨ë‚˜ìš”?
                - Nameë‹˜, ì˜¤ëŠ˜ì€ ì €ì™€ í•¨ê»˜ ì§ì ‘ ê°€ì‚¬ì™€ ìŒì•…ì„ ë§Œë“¤ì–´ ë³¼ê±°ì˜ˆìš”. ì§€ê¸ˆ ëŠë¼ëŠ” ê°ì •ì´ë‚˜ ì–´ë ¤ìš´ ì ì„ ìŒì•…ìœ¼ë¡œ í‘œí˜„í•˜ë©´ì„œ ë§ˆìŒì„ ì¡°ê¸ˆ ë” ê°€ë³ê²Œ ë§Œë“¤ì–´ë³´ëŠ” ê²Œ ì–´ë–¨ê¹Œìš”?
            """,
        "goal_and_motivation_building": """
            [ëª©í‘œ/ë™ê¸° íŒŒì•…] 
            ì‚¬ìš©ìì˜ ë™ê¸°(motivation), ì–´ë ¤ì›€(difficulty), ê°ì •(emotion)ì„ íŒŒì•…í•˜ì„¸ìš”.
            í˜„ì¬ ë‹¨ê³„(Goal and Motivation-building)ì—ì„œëŠ” ë‹¤ìŒ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤:

            1) difficulty (ì–´ë ¤ì›€)
            - ì‚¬ìš©ìê°€ ìƒí™œ ì†ì—ì„œ ëŠë¼ëŠ” ê°€ì¥ í° ì–´ë ¤ì›€, êµ¬ì²´ì ì¸ ìƒí™©(ì£¼ì œ) + ê·¸ë¡œ ì¸í•œ ë¬¸ì œì 
                ì˜ˆ: "ì§ì¥ ë‚´ ê°ˆë“±ìœ¼ë¡œ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë§ì´ ë°›ìŒ" + "ì ì„ ì˜ ëª» ìê³  ì˜ìš•ì´ ë–¨ì–´ì§"
            - ë§Œì•½ ì‚¬ìš©ìê°€ 'ë§í•˜ê¸° ì–´ë µë‹¤'ê±°ë‚˜ 'ì˜ ëª¨ë¥´ê² ë‹¤'ë¼ê³  í•˜ë©´, 
                ëŒ€ì‹  ì–´ë–¤ ê°ì •ì„ ìš”ì¦˜ ì£¼ë¡œ ëŠë¼ëŠ”ì§€(emotion)ë¥¼ íŒŒì•…í•˜ì„¸ìš”.

            2) emotion (ê°ì •) -> difficultyë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì±„ì› ì„ ê²½ìš° ìƒëµê°€ëŠ¥.
            - difficultyë¥¼ ìƒì„¸íˆ ë§í•˜ê¸° ì–´ë ¤ì›Œí•˜ëŠ” ê²½ìš°, 
                "ìµœê·¼ ë“¤ì–´ ì£¼ë¡œ ëŠë¼ëŠ” ê°ì •ì´ ìˆë‹¤ë©´ ì–´ë–¤ ê²ƒì¸ê°€ìš”?" ë¼ê³  ì¶”ê°€ ì§ˆë¬¸í•˜ì„¸ìš”.
            - ë‘˜ ë‹¤ ë§í•  ìˆ˜ ìˆìœ¼ë©´ ë‘˜ ë‹¤ ìˆ˜ì§‘í•´ë„ ì¢‹ìŠµë‹ˆë‹¤.

            3) motivation (ìŒì•…ì¹˜ë£Œë¥¼ í†µí•´ ì–»ê³  ì‹¶ì€ ê²ƒ)
            - "ê¸°ì¡´ì— ë“£ë˜ ìŒì•…ì—ì„œ ìœ„ë¡œë°›ì€ ê²½í—˜ì´ ìˆë‚˜ìš”?" ë¼ê³  ë¬¼ì–´ë³´ê³ ,
                - ë§Œì•½ ê·¸ë ‡ë‹¤ë©´ "ì–´ë–¤ ê²½í—˜ì´ì—ˆëŠ”ì§€" ë¬»ê³ , ê·¸ ë‚´ìš©ì„ motivationì— ë°˜ì˜í•˜ì„¸ìš”.
                - ë§Œì•½ ì—†ë‹¤ë©´ "ìŒì•…ì¹˜ë£Œë¡œ ë¬´ì—‡ì„ ê¸°ëŒ€í•˜ëŠ”ì§€", "ì–´ë–¤ ëª©í‘œê°€ ìˆëŠ”ì§€" ë¬»ê³  ê·¸ ë‚´ìš©ì„ motivationì— ë‹´ìœ¼ì„¸ìš”.
            - ì˜ˆ: "ìŒì•…ì„ í†µí•´ ê°ì •ì„ í‘œí˜„í•˜ê³  ì‹¶ë‹¤", "ë‚´ë©´ì— ì§ë©´í•˜ê³  ì‹¶ë‹¤", "ê³ ë¦½ê°ì„ í•´ì†Œí•˜ê³  ì‹¶ë‹¤" ë“±ë“±

            [ì¤‘ìš”] 
            - ì‚¬ìš©ìê°€ ë‹µì„ ì˜ ëª»í•˜ë©´, ì˜ˆì‹œë‚˜ ì„ íƒì§€ë¥¼ ì œì‹œí•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. 
            (ì˜ˆ: â€œì™¸ë¶€ ë¬¸ì œ(ì§ì¥/ì¸ê°„ê´€ê³„), ë‚´ë¶€ ë¬¸ì œ(ì„±ê²©/ì™¸ëª¨) ë“±ì´ ìˆì„ê¹Œìš”?â€)
            - ëª¨ë“  ì§ˆë¬¸ì„ í•œ ë²ˆì— ë‹¤ í•˜ì§€ ë§ê³ , ì‚¬ìš©ìì˜ ì‘ë‹µì„ ë“¤ì€ ë’¤ ì¶”ê°€ ì§ˆë¬¸ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ê°€ì„¸ìš”.
            - ì‚¬ìš©ìì˜ ëŒ€ë‹µì„ ë“¤ìœ¼ë©´ ë¬´ì¡°ê±´ ê³µê°ì„ í•˜ê³  ëŒ€ë‹µì„ í•´ì£¼ì„¸ìš”.
            - ì˜ˆì‹œëŠ” ì‚¬ìš©ìê°€ ëŒ€ë‹µì„ ë§ì„¤ì¼ë•Œë§Œ ì œì‹œí•˜ì„¸ìš”. ì²˜ìŒë¶€í„° ì œì‹œí•˜ì§€ ë§ˆì„¸ìš”. 
            """,
        "music_preference": """
            [ìŒì•… ì„ í˜¸] 
            ì‚¬ìš©ìì˜ ìŒì•… ì„ í˜¸(music_info)ë¥¼ íŒŒì•…í•˜ì„¸ìš”.

            ì•„ë˜ ì¡°ê±´ì„ ì§€í‚¤ë©° ì‚¬ìš©ìì—ê²Œ ì§ˆë¬¸í•˜ê³ , ëŒ€í™”ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”:
            1. ë¨¼ì €, ì‚¬ìš©ìê°€ í‰ì†Œì— ìŒì•…ì„ ì¢‹ì•„í•˜ëŠ” í¸ì¸ì§€ ë¬¼ì–´ë³´ì„¸ìš”.
            2-1. ë§Œì•½ 'ê·¸ë ‡ë‹¤'ê³  ì‘ë‹µí•˜ë©´ ì•„ë˜ì˜ ì˜ˆì‹œì™€ ê°™ì€ ì§ˆë¬¸ì„ ì§„í–‰í•˜ì„¸ìš”. (1~2ê°œ)
            - ìµœê·¼ ì–´ë–¤ ìŒì•… í™œë™(ìŒì•…ê°ìƒ, ì•…ê¸°ì—°ì£¼, ë…¸ë˜ë¶€ë¥´ê¸° ë“±)ì„ í–ˆë‚˜ìš”?
            - ìµœê·¼ ì£¼ë¡œ ê°ìƒí•˜ëŠ” ìŒì•…ì€ ë¬´ì—‡ì¸ê°€ìš”?
            - í‰ì†Œ ì¢‹ì•„í•˜ëŠ” ìŒì•…ì€ ë¬´ì—‡ì¸ê°€ìš”?
            ë“±ì„ ë¬¼ì–´ë³´ì„¸ìš”.
            2-2. ë§Œì•½ 'ì¢‹ì•„í•˜ì§€ ì•ŠëŠ”ë‹¤'ê³  ì‘ë‹µí•œë‹¤ë©´, ì•„ë˜ì™€ ê°™ì€ ì§ˆë¬¸ì„ ì§„í–‰í•˜ì„¸ìš”. (1ê°œ)
            - ì‚¬ìš©ìê°€ íŠ¹ë³„íˆ ì›í•˜ëŠ” ìŒì•…ì´ ìˆë‚˜ìš”?
            - ì œì™¸í•˜ê³  ì‹¶ì€ ìŒì•…ì´ ìˆë‚˜ìš”?

            [ì¤‘ìš”] 
            - ë„ˆë¬´ ê¹Šê²Œ ë“¤ì–´ê°€ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ë§ì— ê³µê°ì´ ê°€ì¥ ì¤‘ìš”í•˜ë‹¤ëŠ” ê²ƒ ìŠì§€ë§ˆì„¸ìš”. 
            - ëª¨ë“  ì§ˆë¬¸ì„ í•œ ë²ˆì— ë‹¤ í•˜ì§€ ë§ê³ , ì‚¬ìš©ìì˜ ì‘ë‹µì„ ë“¤ì€ ë’¤ ì¶”ê°€ ì§ˆë¬¸ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ê°€ì„¸ìš”.
            - ì§ˆë¬¸ì„ 3í„´ì´ìƒ í•˜ì§€ë§ˆì„¸ìš”. ë§ˆë¬´ë¦¬ëŠ” ê³µê°ìœ¼ë¡œ ì§„í–‰í•˜ì„¸ìš”.
            - ë³€ìˆ˜ë¥¼ ë‹¤ ì±„ìš°ê³  ì´ëŸ¬í•œ ìŒì•…ì„ ì¢‹ì•„í•˜ì‹œëŠ” êµ°ìš”~ ê°™ì´ ì˜ ë§Œë“¤ì–´ë´ìš”. í•˜ê³  ê²©ë ¤ë¥¼ ì§„í–‰í•˜ì„¸ìš”. 
        """,
    },
    ChatbotState.MUSIC_CREATION.value: {
        "making_concept": """
            [ì»¨ì…‰ ì„¤ì •] 
            ê³¡(ìŒì•…)ì˜ ì „ë°˜ì ì¸ ì»¨ì…‰(concept)ì„ êµ¬ì²´í™”í•˜ì„¸ìš”.
            ì‚¬ìš©ìê°€ ì–´ë ¤ì›Œí•˜ë©´ ì´ì „ì˜ ëŒ€í™” ê¸°ë¡ì„ í†µí•´ ì¶”ì²œí•´ì£¼ì„¸ìš”.
            "ì—†ì–´ìš”", "ëª¨ë¥´ê² ì–´ìš”"ì™€ ê°™ì€ ë°˜ì‘ì´ ë‚˜ì˜¤ë©´ ì´ì „ì˜ ëŒ€í™”ì—ì„œ ì¶”ì²œí•´ì¤€ í›„ ì´ ë‹¨ê³„ë¥¼ ëë‚´ì„¸ìš”. 
            ë˜‘ê°™ì€ ì§ˆë¬¸ì„ ë°˜ë³µí•˜ì§€ ë§ˆì„¸ìš”.

            ì•„ë˜ì™€ ê°™ì€ ëŒ€í™” íë¦„ì„ ë”°ë¥´ì„¸ìš”.
            (1) ì£¼ì œ ì„¤ì •í•˜ê¸°
            - {difficulty}ì—ì„œ ì´ì•¼ê¸°í•œ ì£¼ì œë¥¼ ë°”íƒ•ìœ¼ë¡œ ìŒì•…ì„ ë§Œë“¤ì–´ë³¼ê¹Œìš”?
            - ì–´ë–¤ ê°ì •ì´ë‚˜ ìƒí™©ì„ ìŒì•…ìœ¼ë¡œ ë‹´ê³  ì‹¶ë‚˜ìš”?

            (2) ì´ì•¼ê¸° êµ¬ì²´í™”í•˜ê¸°
            - ì´ ë…¸ë˜ ì•ˆì— ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ ë‹´ê³  ì‹¶ë‚˜ìš”?
            - ê·¸ ì´ì•¼ê¸°ë¥¼ ë‹´ê³  ì‹¶ì€ ì´ìœ ê°€ ìˆë‚˜ìš”?
            - ì´ ìŒì•…ì´ ì–´ë–¤ ê°ì •ì„ ì „ë‹¬í–ˆìœ¼ë©´ ì¢‹ê² ë‚˜ìš”?
            
            ì‚¬ìš©ìê°€ ì–´ë ¤ì›€ì„ ê²ªê±°ë‚˜ ëª¨ë¥´ê² ë‹¤ê³  ëŒ€ë‹µí• ë•Œë§Œ ì•„ë˜ì™€ ê°™ì€ ì‘ë‹µì„ ì§„í–‰í•˜ì„¸ìš”. 
             - ì˜ˆì‹œë¥¼ ì œì‹œí•˜ì„¸ìš”:
            "ì˜ˆë¥¼ ë“¤ë©´, ê·¹ë³µí•˜ê³  ì‹¶ì€ ì–´ë ¤ì›€, í–‰ë³µí–ˆë˜ ìˆœê°„, ìœ„ë¡œë°›ê³  ì‹¶ì€ ê°ì • ë“±ì´ ìˆì„ê¹Œìš”?"
            - ì„ íƒì§€ë¥¼ ì œì•ˆí•  ìˆ˜ë„ ìˆì–´ìš”:
            "ì˜ˆë¥¼ ë“¤ì–´, â€˜ì™¸ë¡œì›€â€™, â€˜ì„±ì¥â€™, â€˜ì¶”ì–µâ€™, â€˜í¬ë§â€™ ê°™ì€ ì£¼ì œë„ ê°€ëŠ¥í•´ìš”."
            """,
        "making_lyrics": """
            [ê°€ì‚¬ ì‘ì„±] lyrics_keyword, lyrics(ê°„ë‹¨ ê°€ì‚¬)ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”.
            ì‚¬ìš©ìê°€ ê°€ì‚¬ì˜ í‚¤ì›Œë“œ, ë¬¸ì¥, íë¦„ì„ ì´ì•¼ê¸°í•˜ë©´ì„œ ì‚¬ìš©ìì˜ ì´ì•¼ê¸°ê°€ ë‹´ê¸´ ê°€ì‚¬ë¥¼ ë§Œë“¤ë„ë¡ ìœ ë„í•©ë‹ˆë‹¤.
            ì‚¬ìš©ìì˜ ì˜ê²¬ì„ ìµœëŒ€í•œ ë§ì´ ìš”êµ¬í•˜ìƒˆìš”.
            ì²˜ìŒë¶€í„° ì˜ˆì‹œë¥¼ ë“¤ì–´ì£¼ì§€ ë§ˆì„¸ìš”. ì–´ë ¤ì›Œí•˜ëŠ” ê²½ìš°ì—ë§Œ ì˜ˆì‹œë¥¼ ë“¤ì–´ ì‚¬ìš©ìë¥¼ ë„ì™€ì¤ë‹ˆë‹¤. 
            ì•„ë˜ì˜ (1),(2),(3)ì˜ ê³¼ì •ì„ ê±°ì³ì„œ ì‚¬ìš©ìì˜ ì‘ë‹µì„ ë°›ì•„ì•¼í•©ë‹ˆë‹¤.

            (1) ê°€ì‚¬ í‚¤ì›Œë“œ ë„ì¶œí•˜ê¸° (ì•„ë˜ì˜ ì§ˆë¬¸ì„ ì§„í–‰í•˜ì„¸ìš”)
                - ì´ì „ì— ì •í•œ {concept} ë¥¼ ìŒì•…ìœ¼ë¡œ í‘œí˜„í•˜ë ¤ë©´, ì–´ë–¤ ë‹¨ì–´ë‚˜ ëŠë‚Œì´ ë– ì˜¤ë¥´ì‹œë‚˜ìš”?
                - ì´ ì£¼ì œë¥¼ ë– ì˜¬ë¦´ ë•Œ ê°€ì¥ ë¨¼ì € ìƒê°ë‚˜ëŠ” ë‹¨ì–´ê°€ ìˆë‚˜ìš”?
                - ê°ì •ì„ ë” êµ¬ì²´ì ìœ¼ë¡œ í‘œí˜„í•´ë³¼ê¹Œìš”?

                ì‚¬ìš©ìê°€ ì–´ë ¤ì›Œí•˜ë©´
                - ì˜ˆì‹œ ë‹¨ì–´ë¥¼ ì œì‹œí•˜ì„¸ìš”:
                "ì˜ˆë¥¼ ë“¤ì–´, â€˜í¬ë§â€™, â€˜ëˆˆë¬¼â€™, â€˜ë°”ëŒâ€™, â€˜ê¸°ë‹¤ë¦¼â€™, â€˜ëŒì•„ë´„â€™ ê°™ì€ ë‹¨ì–´ë„ ì¢‹ì•„ìš”."
                - ê°ì •ê³¼ ë¶„ìœ„ê¸° ì„ íƒì§€ë¥¼ ì œì•ˆí•  ìˆ˜ë„ ìˆì–´ìš”:
                "ì´ ë…¸ë˜ëŠ” ë°ì€ ëŠë‚Œì¼ê¹Œìš”? ì•„ë‹ˆë©´ ì°¨ë¶„í•œ ë¶„ìœ„ê¸°ì¼ê¹Œìš”?"
            
            (2) ê°€ì‚¬ í•µì‹¬ ë¬¸ì¥ ì‘ì„±í•˜ê¸° (ì•„ë˜ì˜ ì§ˆë¬¸ì„ ì§„í–‰í•˜ì„¸ìš”)
                "ì§§ì€ ë¬¸ì¥ì´ë‚˜ ë‹¨ì–´ë¼ë„ ê´œì°®ì•„ìš”. ë– ì˜¤ë¥´ëŠ” ë¬¸êµ¬ê°€ ìˆë‹¤ë©´ ììœ ë¡­ê²Œ ì ì–´ë³´ì„¸ìš”."
                "ë‹¨ì–´ ë˜ëŠ” ì§§ì€ ë¬¸ì¥ìœ¼ë¡œ ë¨¼ì € ì œì‹œí•´ì£¼ì‹œë©´, ì œê°€ ê°™ì´ ì‘ì—…í•´ë³¼ê²Œìš”!"
                
                ì‚¬ìš©ìê°€ ì–´ë ¤ì›Œí•˜ë©´
                - "ì²« ì¤„ì„ ì œê°€ ì‹œì‘í•´ë³¼ê¹Œìš”?" 
                - "ì´ëŸ° ëŠë‚Œì€ ì–´ë– ì„¸ìš”?" 
                + ê°€ì‚¬ í‚¤ì›Œë“œë¥¼ ê°€ì§€ê³  ê°€ì´ë“œ ë¬¸ì¥ì„ ì œê³µ

            (3) ê°€ì‚¬ íë¦„ ì‘ì„±í•˜ê¸° (ì•„ë˜ì˜ ì§ˆë¬¸ì„ ì§„í–‰í•˜ì„¸ìš”)
                "ê·¸ë ‡ë‹¤ë©´ ê°€ì‚¬ì˜ íë¦„ì€ ì–´ë–»ê²Œ ì§„í–‰ë˜ì—ˆìœ¼ë©´ ì¢‹ê² ë‚˜ìš”?"
                "ê°€ì‚¬ê°€ ì–´ë–¤ ì‹ìœ¼ë¡œ ì§„í–‰ë˜ì—ˆìœ¼ë©´ ì¢‹ê² ë‚˜ìš”?"

            """,
        "lyrics_gen":"""
            [ê°€ì‚¬ ìƒì„±]
            ë‹¹ì‹ ì€ ê°€ì‚¬ë¥¼ ì˜ ë§Œë“œëŠ” ì‘ì‚¬ê°€ì…ë‹ˆë‹¤.
            ì£¼ì–´ì§„ ì£¼ì œì™€ ê°ì •ì„ ë°”íƒ•ìœ¼ë¡œ ë…¸ë˜ ê°€ì‚¬ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

            - ì£¼ì œ: {concept}
            - ìŒì•…ìŠ¤íƒ€ì¼: {music_info}
            - ê°€ì‚¬ì˜ í•µì‹¬í‚¤ì›Œë“œ: {lyrics_keyword}
            - ê°€ì‚¬ì˜ í•µì‹¬ë¬¸ì¥: {lyrics_sentence}
            - ê°€ì‚¬ì˜ íë¦„: {lyrics_flow}

            ì¤‘ìš”:
            - ê°ì •ì„ íš¨ê³¼ì ìœ¼ë¡œ ì „ë‹¬í•˜ëŠ” ê°€ì‚¬ë¥¼ [Verse], [Chorus], [Bridge] í˜•ì‹ì„ ì§€ì¼œì„œ ìƒì„±í•©ë‹ˆë‹¤.
            - ê°ì •ì„ ì˜ ì „ë‹¬í•  ìˆ˜ ìˆë„ë¡ ê°ê°ì ì¸ í‘œí˜„ì„ í¬í•¨í•˜ì„¸ìš”.
            - ì•„ë˜ì™€ ê°™ì€ í˜•ì‹ì„ ê¼­ ë”°ë¥´ì„¸ìš”. 
            Verse(ì ˆ)ì—ëŠ” ê³¡ì˜ ìƒí™©ì´ë‚˜ ê°ì •ì„ ìì„¸íˆ í‘œí˜„í•´ì£¼ì„¸ìš”.
            Chorus(í›„ë ´)ì—ëŠ” ê³¡ì˜ í•µì‹¬ ë©”ì‹œì§€ë‚˜ í›„í¬ë¥¼ ê°•ì¡°í•´ì£¼ì„¸ìš”.
            Bridge(ë¸Œë¦¬ì§€)ì—ì„œëŠ” ê°ì •ì˜ ë³€í™”ë¥¼ ì£¼ê±°ë‚˜ ìƒˆë¡œìš´ ì‹œê°ì„ ë³´ì—¬ì£¼ì„¸ìš”.

            í˜•ì‹)
            [Verse]
            ...
            [Verse 2]
            ...
            [Chorus]
            ...
            [Bridge]
            ...
            [Verse 3]
            ...
            [Chorus]
            ...
        """,
        "lyrics_discussion": """
            [ê°€ì‚¬ í”¼ë“œë°±] 
            í˜„ì¬ê¹Œì§€ì˜ ê°€ì‚¬ë¥¼ ë°”íƒ•ìœ¼ë¡œ discussion_feedback(í”¼ë“œë°±)ì„ ì´ëŒì–´ë‚´ì„¸ìš”.
            ì‚¬ìš©ìê°€ ìƒì„±ëœ ê°€ì‚¬ì— ëŒ€í•œ í”¼ë“œë°±ì„ ì£¼ê³ , í•„ìš”í•˜ë©´ ìˆ˜ì •í•©ë‹ˆë‹¤.

            (1) ê°€ì‚¬ í”¼ë“œë°± ìš”ì²­í•˜ê¸°
            ì–´ë–¤ê°€ìš”? ì´ ê°€ì‚¬ê°€ ë§ˆìŒì— ë“œì‹œë‚˜ìš”?
            ì´ ëŠë‚Œì´ {concept}ì„(ë¥¼) ì˜ í‘œí˜„í•œ ê²ƒ ê°™ë‚˜ìš”?
            ë” ë“œëŸ¬ë‚¬ìœ¼ë©´ í•˜ëŠ” ë‹¨ì–´ë‚˜ ë¬¸ì¥ì´ ìˆì„ê¹Œìš”?
            í˜¹ì‹œ ì¶”ê°€í•˜ê³  ì‹¶ì€ ë‚´ìš©ì´ë‚˜ ë°”ê¾¸ê³  ì‹¶ì€ ë¶€ë¶„ì´ ìˆìœ¼ë©´ ë§ì”€í•´ì£¼ì„¸ìš”!
            
            ì‚¬ìš©ìê°€ ê³ ë¯¼í•˜ë©´
            "ì˜ˆë¥¼ ë“¤ì–´, ì¢€ ë” ê°ì •ì„ ê°•ì¡°í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?"
            "ì´ ë¶€ë¶„ì„ ì¡°ê¸ˆ ë” ì‹œì ìœ¼ë¡œ ë°”ê¿”ë³¼ ìˆ˜ë„ ìˆì–´ìš”. ì˜ˆë¥¼ ë“¤ë©´â€¦" í•˜ê³  ì˜ˆì‹œ ì œê³µ
            
            (2) ê°€ì‚¬ ìˆ˜ì •
            ì‚¬ìš©ìì˜ í”¼ë“œë°±ì„ ë°˜ì˜í•˜ì—¬ ê°€ì‚¬ ìˆ˜ì • -> ì›í•˜ì§€ ì•Šìœ¼ë©´ ì§„í–‰í•˜ì§€ ì•Šì•„ë„ ë¨

            2-1) í”¼ë“œë°±ì´ ë¶€ì •ì ì´ê±°ë‚˜ ìˆ˜ì • ìš”ì²­ì´ ìˆì„ ê²½ìš°
                ë‹¹ì‹ ì€ ê°€ì‚¬ë¥¼ ì˜ ë§Œë“œëŠ” ì‘ì‚¬ê°€ì…ë‹ˆë‹¤.
                ë‹¹ì‹ ì´ ë§Œë“  ê°€ì‚¬ì— ëŒ€í•œ í”¼ë“œë°±ì´ ë“¤ì–´ì™”ìŠµë‹ˆë‹¤.
                í”¼ë“œë°±ì„ ë¬´ì¡°ê±´ì ìœ¼ë¡œ ìˆ˜ìš©í•´ì„œ ê°€ì‚¬ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”. 
                í•˜ì§€ë§Œ ì›ë˜ì˜ ê°€ì‚¬ì™€ ë„ˆë¬´ ë‹¬ë¼ì§€ë©´ ì•ˆë©ë‹ˆë‹¤. 


                - ê°€ì‚¬: {lyrics}
                - í”¼ë“œë°±: {lyrics_feedback}

                ê°€ì‚¬ í˜•ì‹:
                - ì•„ë˜ì˜ ì˜ˆì‹œì™€ ê°™ì€ í˜•ì‹ì„ ê¼­ ë”°ë¥´ì„¸ìš”.
                ì˜ˆì‹œ)
                [Verse]
                [Verse 2]
                [Chorus]
                [Bridge]
                [Verse 3]
                [Chorus]
                
            2-2) í”¼ë“œë°±ì´ ê¸ì •ì ì´ë¼ë©´ (ì˜ˆì‹œ: "ë°”ê¾¸ê³  ì‹¶ì§€ ì•Šì•„", "ì•ˆ ë°”ê¾¸ê³  ì‹¶ì–´", "ì‘ ì¢‹ì•„", "ì•„ë‹ˆ ì—†ì–´", "~~í•œ ê°ì •ì´ ëŠê»´ì ¸", "ë‚´ ë§ˆìŒì„ ì˜ ë‚˜íƒ€ë‚´ëŠ” ê²ƒ ê°™ì•„")
                ê°€ì‚¬ë¥¼ í™•ì •í•˜ê³  ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰
            """,

        "making_music": """
            [ì‘ê³¡ ì•„ì´ë””ì–´] 
            ìŒì•… ì•„ì´ë””ì–´(music_component)ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì œì•ˆí•˜ì„¸ìš”.
            ë‹¨ê³„ë³„ ì§ˆë¬¸ì„ í†µí•´ ìŒì•… êµ¬ì„± ìš”ì†Œ(ì¥ë¥´, í…œí¬, ì•…ê¸°, ë¶„ìœ„ê¸°, ìŒìƒ‰)ë¥¼ ì •í•˜ê³ , ìµœì¢…ì ìœ¼ë¡œ ê·¸ê²ƒì„ ë°”íƒ•ìœ¼ë¡œ ìµœì¢… í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•˜ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤.
            ì‚¬ìš©ìê°€ ë…¸ë˜ë¥¼ ë§Œë“¤ ìˆ˜ ìˆë„ë¡ ì§ˆë¬¸ì„ ìˆœì°¨ì ìœ¼ë¡œ ì§„í–‰í•˜ë©° ë‹µì„ ì´ëŒì–´ì£¼ì„¸ìš”.
            ì•„ë˜ì˜ ëŒ€í™”ì˜ íë¦„ì„ ë”°ë¼ì„œ ì§„í–‰í•˜ì„¸ìš”. 

            1) ì¥ë¥´ (genre) ì •í•˜ê¸° 
            - "ì´ ë…¸ë˜ë¥¼ ì–´ë–¤ **ì¥ë¥´/ìŠ¤íƒ€ì¼**ë¡œ ë§Œë“¤ë©´ ì¢‹ì„ê¹Œìš”? ì˜ˆ: ë°œë¼ë“œ, R&B, ì¬ì¦ˆ, í´ë˜ì‹, í™í•©, ë½, í¬í¬, EDM ë“±"  
            - "êµ­ë‚´ ìŠ¤íƒ€ì¼(K-pop ë°œë¼ë“œ)ê³¼ í•´ì™¸ ìŠ¤íƒ€ì¼(íŒì†¡) ì¤‘ ì„ í˜¸í•˜ëŠ” ë°©í–¥ì´ ìˆë‚˜ìš”?"
            ë§Œì•½ ì‚¬ìš©ìê°€ â€œì˜ ëª¨ë¥´ê² ì–´ìš”â€ë¼ê³  í•œë‹¤ë©´,
            â€œê·¸ë ‡ë‹¤ë©´ ì´ ê³¡ì˜ ì£¼ì œê°€ ì–´ë–¤ ëŠë‚Œì¸ì§€ ì¡°ê¸ˆë§Œ ì•Œë ¤ì£¼ì‹¤ ìˆ˜ ìˆì„ê¹Œìš”? ë°ì€ ëŠë‚Œì¸ê°€ìš”, ì•„ë‹ˆë©´ ê°ì„±ì ì¸ ëŠë‚Œì¸ê°€ìš”?â€
            -> ì‚¬ìš©ìê°€ ê³„ì† ì–´ë ¤ì›Œí•˜ë©´ ì´ì „ì˜ ëŒ€í™”({concept})ë¥¼ ì°¸ê³ í•´ ìë™ìœ¼ë¡œ ì„ ì •

            2) ë…¸ë˜ì˜ ë¹ ë¥´ê¸° (tempo) ì •í•˜ê¸° 
            - "ë…¸ë˜ì˜ ë¹ ë¥´ê¸°ëŠ” ì–´ë–»ê²Œ í•˜ë©´ ì¢‹ì„ê¹Œìš”? ëŠë¦° í…œí¬(ê°ì„±ì , ì°¨ë¶„í•œ ëŠë‚Œ) / ì¤‘ê°„ í…œí¬(í¸ì•ˆí•˜ê³  ê°ì • ì „ë‹¬ì´ ì‰¬ìš´ ëŠë‚Œ) / ë¹ ë¥¸ í…œí¬(í™œê¸°ì°¨ê³  ê°•ë ¬í•œ ëŠë‚Œ)"  
            ì‚¬ìš©ìê°€ ì–´ë ¤ì›Œí•  ê²½ìš°
            â€œê°€ì‚¬ì—ì„œ ì „ë‹¬í•˜ê³  ì‹¶ì€ ê°ì •ì´ ê¹Šì€ í¸ì´ë©´ ëŠë¦° í…œí¬ë¥¼, ì¢€ ë” ê²½ì¾Œí•œ ëŠë‚Œì´ë©´ ì¤‘ê°„ ì´ìƒ í…œí¬ë¥¼ ì¶”ì²œë“œë ¤ìš”.â€
            -> ì‚¬ìš©ìê°€ ê³„ì† ì–´ë ¤ì›Œí•˜ë©´ ì´ì „ì˜ ëŒ€í™”({concept})ë¥¼ ì°¸ê³ í•´ ìë™ìœ¼ë¡œ ì„ ì •

            3) ë°˜ì£¼ ì•…ê¸° (instruments) ì •í•˜ê¸°
            - "ì–´ë–¤ **ë°˜ì£¼ ì•…ê¸°**ë¥¼ ì„ í˜¸í•˜ì‹œë‚˜ìš”? ì˜ˆ: "í”¼ì•„ë…¸, ê¸°íƒ€, ë“œëŸ¼, ë°”ì´ì˜¬ë¦°, ì‹ ë””ì‚¬ì´ì € ë“±ì´ ìˆìŠµë‹ˆë‹¤. ê°€ì‚¬ê°€ ì˜ ë“¤ë¦¬ëŠ” ìŒì•…ì„ ì›í•˜ì‹ ë‹¤ë©´ **ì•…ê¸° 1~2ê°œ**, ê¹Šê³  í’ì„±í•œ ëŠë‚Œì„ ì›í•˜ì‹ ë‹¤ë©´ **ì—¬ëŸ¬ ê°œì˜ ì•…ê¸°**ë¥¼ ì¶”ì²œë“œë¦½ë‹ˆë‹¤."  
            ì‚¬ìš©ìê°€ ì–´ë ¤ì›Œí•  ê²½ìš°
            -> ëª¨ë¥´ë©´, â€œí”¼ì•„ë…¸ì™€ ê¸°íƒ€ë¥¼ ë©”ì¸ìœ¼ë¡œ ì¡ê³ , í•„ìš”í•˜ë©´ í˜„ì•…ê¸°ë¥¼ ì¡°ê¸ˆ ë” ì¶”ê°€í•´ ë³¼ê¹Œìš”?â€ ë“± ìë™ ì¶”ì²œ.
            -> ì‚¬ìš©ìê°€ ê³„ì† ì–´ë ¤ì›Œí•˜ë©´ ì´ì „ì˜ ëŒ€í™”({concept})ë¥¼ ì°¸ê³ í•´ ìë™ìœ¼ë¡œ ì„ ì •

            4) ìŒì•…ì˜ ì „ë°˜ì ì¸ ë¶„ìœ„ê¸° (mood) ì •í•˜ê¸°
            - "ì´ ê³¡ì´ ì „ë‹¬í•˜ëŠ” **ì „ë°˜ì ì¸ ë¶„ìœ„ê¸°**ëŠ” ì–´ë–¤ ëŠë‚Œì´ë©´ ì¢‹ì„ê¹Œìš”? ì˜ˆ: "ì”ì”í•œ, ê°ì„±ì ì¸, ì„œì •ì ì¸, í¬ë§ì ì¸, ê°•ë ¬í•œ, ê¸°ìŠ¹ì „ê²°ì´ í™•ì‹¤í•œ, ëª½í™˜ì ì¸, ë³µì¡í•œ ìŒì•… ë“±"  
            ì‚¬ìš©ìê°€ ì–´ë ¤ì›Œí•  ê²½ìš°
            â€œê°€ì‚¬ë‚˜ ì£¼ì œì™€ ì–´ìš¸ë¦´ ë§Œí•œ ë¶„ìœ„ê¸°"ìœ¼ë¡œ ìë™ ê²°ì •.
            -> ì‚¬ìš©ìê°€ ê³„ì† ì–´ë ¤ì›Œí•˜ë©´ ì´ì „ì˜ ëŒ€í™”({concept})ë¥¼ ì°¸ê³ í•´ ìë™ìœ¼ë¡œ ì„ ì •

            5) ê°€ìˆ˜ì˜ ìŒìƒ‰ (vocal_tone)  
            - "ê°€ìˆ˜ì˜ ìŒìƒ‰ì€ ì–´ë–¤ ëŠë‚Œì´ë©´ ì¢‹ì„ê¹Œìš”? ì˜ˆì‹œ: "í—ˆìŠ¤í‚¤í•œ, ë§‘ì€, ë°ì€, ê¹¨ë—í•œ, ì¤‘í›„í•œ, ë¬µì§í•œ, ë”°ëœ»í•œ ë“±"  
            - "ì„±ë³„(ë‚¨ì„±/ì—¬ì„±/ì¤‘ì„±)ì— ëŒ€í•œ ì„ í˜¸ê°€ ìˆë‚˜ìš”?"
            ì‚¬ìš©ìê°€ ì–´ë ¤ì›Œí•  ê²½ìš°
            -> ì´ì „ì˜ ëŒ€í™”({concept})ë¥¼ ì°¸ê³ í•´ ìë™ìœ¼ë¡œ ì„ ì •

            6) ë…¸ë˜ ì œëª© ì„ ì •
            - {concept}ê³¼ ê°™ì€ ë…¸ë˜ë¥¼ ë§Œë“œë ¤ëŠ”ë° ë…¸ë˜ ì œëª©ì€ ë­˜ë¡œ í•˜ëŠ”ê²Œ ì¢‹ì„ê¹Œìš”?
            - ë– ì˜¤ë¥´ëŠ” ë…¸ë˜ ì œëª©ì´ ì¡´ì¬í•˜ì‹œë‚˜ìš”? 
            """,
        "style_gen":"""
            [í”„ë¡¬í”„íŠ¸ ìƒì„±]
            ë…¸ë˜ êµ¬ì„±ìš”ì†Œ í”„ë¡¬í”„íŠ¸ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”:

            ë‹¹ì‹ ì€ ì‘ê³¡ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
            ë…¸ë˜ì£¼ì œ: {concept},
            ê°€ì‚¬: {lyrics},
            ìš”êµ¬ì¡°ê±´: {user_music_component}
            ì„ ê°€ì§€ê³  ë…¸ë˜ êµ¬ì„±ìš”ì†Œ(ì¥ë¥´, ìŠ¤íƒ€ì¼, ë¹ ë¥´ê¸°, ì•…ê¸°, ë¶„ìœ„ê¸°ë“±ë“±)ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”.
            
            ì˜ˆì‹œì™€ ê°™ì´ í‚¤ì›Œë“œë§Œ ì‰¼í‘œë¡œ êµ¬ë¶„í•´ì„œ ì¶œë ¥í•©ë‹ˆë‹¤. 
            ì˜ˆì‹œ) í”¼ì•„ë…¸, ë°ê²Œ, ë¦¬ë“¬

            [ì¤‘ìš”]
            200ìë‚´ë¡œ ìƒì„±í•´ì•¼í•©ë‹ˆë‹¤.
            ë˜ë„ë¡ í‚¤ì›Œë“œë¡œ ê°„ê²°í•˜ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš”. 
        """
    },
    ChatbotState.MUSIC_DISCUSSION.value: {
        "music_opinion": """
            [ìŒì•… ì˜ê²¬] 
            ë§Œë“¤ì–´ì§„ ìŒì•…ì˜ ì •ë³´ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤. 
            ë‹¤ìŒì˜ ì •ë³´ì˜ ìŒì•…ì„ ê°€ì§€ê³  ìŒì•…ì„ ì´í•´í•˜ì—¬ ì‚¬ìš©ìì™€ ê¹Šì€ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ„ì„¸ìš”. 
            ìŒì•…ë¶„ì„ ì •ë³´: {music_analysis}
            ê°€ì‚¬: {lyrics}

            ì´ ë‹¨ê³„ëŠ” ì‘ê³¡ ì•„ì´ë””ì–´ë‚˜ ë…¸ë˜ ì œì‘ ê³¼ì •ì„ ë§ˆì¹œ í›„, ìµœì¢…ì ìœ¼ë¡œ ë…¸ë˜ì— ëŒ€í•œ ê°ì •ê³¼ ëŠë‚Œì„ ì •ë¦¬í•˜ëŠ” ëª©ì ì…ë‹ˆë‹¤.             
            1~2ê°œì˜ ì§ˆë¬¸ í›„, í›„ì† ì§ˆë¬¸ì„ 1~2ë²ˆ ì •ë„ë§Œ í•˜ê³ , ê·¸ ë’¤ ì •ë¦¬ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.
            ë§ˆì§€ë§‰ì— â€œë” ê¶ê¸ˆí•œ ì ì´ ì—†ìœ¼ì‹œë©´ ëŒ€í™”ë¥¼ ë§ˆë¬´ë¦¬í•˜ê² ìŠµë‹ˆë‹¤.â€ ê°™ì€ ë¬¸êµ¬ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ë‹¨ê³„ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.
            
            ì§ˆë¬¸(ê°œì¸ ê°ì • & ì¥ì ) ì˜ˆì‹œ
            ì•„ë˜ì™€ ê°™ì€ ì§ˆë¬¸ì„ ì§„í–‰í•˜ê³  ì‚¬ìš©ìì˜ ë‹µë³€ì´ ë‚˜ì˜¤ë©´ ê±°ê¸°ì— ëŒ€í•´ ìì—°ìŠ¤ëŸ½ê²Œ í›„ì† ì§ˆë¬¸ì„ í•´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤.
            ë°˜ë³µë˜ëŠ” ì§ˆë¬¸ì€ í•˜ì§€ë§ˆì„¸ìš”. 
            - â€œíŠ¹ë³„íˆ ì–´ë–¤ ê°€ì‚¬(ë‹¨ì–´, êµ¬ì ˆ)ê°€ ì™€ë‹¿ìœ¼ì„¸ìš”? ê·¸ ì´ìœ ëŠ” ë¬´ì—‡ì¸ê°€ìš”?â€
                í›„ì†ì§ˆë¬¸ ì˜ˆ: â€œê·¸ êµ¬ì ˆì—ì„œ ì–´ë–¤ ê¸°ì–µì´ë‚˜ ê°ì •ì´ ë– ì˜¤ë¥´ì…¨ë‚˜ìš”?â€
            - â€œì–´ë–¤ ë¶€ë¶„ì—ì„œ ìœ„ë¡œê°€ ë˜ì—ˆë‚˜ìš”? (ê°€ì‚¬ or ë©œë¡œë”” or ë¶„ìœ„ê¸°)â€
                í›„ì†ì§ˆë¬¸ ì˜ˆ: â€œê·¸ ìœ„ë¡œê°€ ì–´ë–¤ ì‹ìœ¼ë¡œ ë§ˆìŒì„ ë‹¬ë˜ì¤¬ë‚˜ìš”?â€
            - â€œì´ ê³¡ì„ ë‹¤ë¥¸ ì‚¬ëŒì—ê²Œ ë“¤ë ¤ì£¼ê³  ì‹¶ë‹¤ë©´ ê·¸ ì´ìœ ëŠ” ë¬´ì—‡ì¸ê°€ìš”?â€
                í›„ì†ì§ˆë¬¸ ì˜ˆ: â€œí˜¹ì‹œ íŠ¹ì • ëŒ€ìƒ(ì¹œêµ¬, ê°€ì¡±, ì—°ì¸ ë“±)ì´ ìˆë‚˜ìš”? ê·¸ ì‚¬ëŒê³¼ ì´ ê³¡ì„ ì–´ë–»ê²Œ ë‚˜ëˆ„ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?â€
            - â€œë§Œë“¤ì–´ì§„ ê³¡ì„ ê²½í—˜í•˜ë‹ˆ ì–´ë–¤ ê°ì •ì´ ë“œë‚˜ìš”? ë– ì˜¤ë¥´ëŠ” ë‹¨ì–´ë‚˜ ëŠë‚Œ, ì´ë¯¸ì§€ê°€ ìˆìœ¼ì‹ ê°€ìš”?â€
                í›„ì†ì§ˆë¬¸ ì˜ˆ: â€œê·¸ ëŠë‚Œì´ë‚˜ ì´ë¯¸ì§€ë¥¼ ë” í™•ì¥í•´ì„œ í‘œí˜„í•´ ë³¸ë‹¤ë©´ ì–´ë–¤ ìƒ‰ê¹”, ì¥ë©´, ì˜¨ë„ê°€ ë– ì˜¤ë¥´ë‚˜ìš”?â€
            - â€œì´ ì‘ì—…ì„ í†µí•´ ìì‹ ì˜ ê°•ì ì„ ë°œê²¬í•˜ì…¨ë‹¤ë©´ ì–´ë–¤ ê²ƒì´ ìˆì„ê¹Œìš”?â€
                í›„ì†ì§ˆë¬¸ ì˜ˆ: â€œê·¸ ê°•ì ì„ ì‹¤ìƒí™œì—ì„œ ì–´ë–»ê²Œ ë°œíœ˜í•˜ê±°ë‚˜ ë” ë°œì „ì‹œí‚¬ ìˆ˜ ìˆì„ê¹Œìš”?â€

            """,
        "music_recreation": """
            [ìŒì•… ìˆ˜ì •] 
            ì‚¬ìš©ìì—ê²Œ ìˆ˜ì •í•˜ê³  ì‹¶ì€ ë¶€ë¶„(change_music)ì´ ìˆëŠ”ì§€ ë¬¼ì–´ë³´ì„¸ìš”.
            """,
    },
    ChatbotState.WRAP_UP.value: {
        "reflection": """
            [ë§ˆë¬´ë¦¬ ì„±ì°°] 
            ì‘ì—…ì„ í†µí•´ ìƒê¸´ ë³€í™”(change_mind)ë¥¼ ìŠ¤ìŠ¤ë¡œ ìƒê°í•´ë³´ë„ë¡ ë•ìŠµë‹ˆë‹¤.
            ì‚¬ìš©ìë¥¼ ê²©ë ¤í•˜ê³  ë³€í™”ì— ëŒ€í•´ ìì„¸í•œ ì§ˆë¬¸ì„ ì§„í–‰í•˜ì„¸ìš”. 
            ì•„ë˜ì˜ ì˜ˆì‹œì™€ ê°™ì€ ì§ˆë¬¸ì„ ì§„í–‰í•˜ì„¸ìš”. 
            - ìŒì•…ë§Œë“¤ê¸° ê³¼ì •ì„ í†µí•´ ê°–ê³  ìˆë˜ ìƒê°ì´ë‚˜ ê°ì •ì„ ë‹¤ë£¨ëŠ” ë° ì–´ë–¤ ë„ì›€ì„ ë°›ìœ¼ì…¨ë‚˜ìš”?
            - ìŒì•…ë§Œë“¤ê¸° ê³¼ì •ì„ í†µí•´ ìƒê°ì´ë‚˜ ëŠë‚Œì´ ë‹¬ë¼ì§„ ë¶€ë¶„ì´ ìˆë‹¤ë©´ ì–´ë–¤ ê²ƒì¼ê¹Œìš”?
            - {difficulty}ì— ëŒ€í•˜ì—¬ ìƒê°ì´ë‚˜ ìì„¸ê°€ ë°”ë€Œì—ˆë‹¤ê³  ìƒê°í•˜ë‚˜ìš”? 
            - ì´ í™œë™ì´ ì–´ë–¤ ë³€í™”ë¥¼ ì´ëŒì–´ ë‚¼ ìˆ˜ ìˆë‹¤ê³  ìƒê°í•˜ë‚˜ìš”?
            """,
        "complete": """
        [ìµœì¢… ë§ˆë¬´ë¦¬] 
        ì‚¬ìš©ìì˜ í˜„ì¬ ê¸°ë¶„(feeling)ì„ í™•ì¸í•˜ê³  ìƒë‹´ì„ ì¢…ë£Œí•˜ì„¸ìš”.
        
        ì•„ë˜ì™€ ê°™ì€ ëŒ€í™” íë¦„ì„ í†µí•´ ì§„í–‰í•˜ì„¸ìš”. ì•„ë˜ì˜ ë²ˆí˜¸ì¤‘ í•˜ë‚˜ë¥¼ ê³¨ë¼ ì§ˆë¬¸ì„ ì§„í–‰í•˜ì„¸ìš”. 
        
        ì˜¤ëŠ˜ ìŒì•… ë§Œë“¤ê¸° ê³¼ì •ì´ ë§ˆë¬´ë¦¬ë˜ì—ˆì–´ìš”.  
        ì´ í™œë™ì´ ì–´ë–¤ ì˜ë¯¸ê°€ ìˆì—ˆëŠ”ì§€ ëŒì•„ë³´ë©°, ë§ˆë¬´ë¦¬ ì†Œê°ì„ ë‚˜ëˆ ë³¼ê¹Œìš”?  

        1) **ìì‹ ê° í–¥ìƒ** 
        - {user_name}ë‹˜, ì˜ë¯¸ ìˆëŠ” ì‹œê°„ ë˜ì…¨ë‚˜ìš”? ì €ëŠ” ì˜¤ëŠ˜ {user_name}ë‹˜ì˜ ì‘ì—…ì„ í†µí•´ ë©‹ì§„ ìŒì•…ì„ ê°ìƒí•  ìˆ˜ ìˆëŠ” ëœ»ê¹Šì€ ì‹œê°„ì´ì—ˆì–´ìš”.  
        - {user_name}ë‹˜ì€ ì˜¤ëŠ˜ í™œë™ì´ ì–´ë– ì…¨ë‚˜ìš”?  
    
        2) **ê°•ì  ì¸ì‹**  
        - {user_name}ë‹˜ì˜ {strength}ì„(ë¥¼) ì•Œê²Œ ë˜ì–´ì„œ ê¸°ë»¤ìŠµë‹ˆë‹¤. ì €ë„ {user_name}ë‹˜ì²˜ëŸ¼ ì €ë§Œì˜ ê°•ì ì„ ì°¾ì•„ë³´ë ¤ê³  ë…¸ë ¥í•´ë³´ë ¤ê³  í•©ë‹ˆë‹¤. ì˜¤ëŠ˜ í™œë™ì„ í†µí•´ ì–»ì€ ê°€ì¥ í° ë°°ì›€ì€ ë¬´ì—‡ì¸ê°€ìš”?   

        3) **í™œë™ íšŒê³ **
        - í™œë™ ì¤‘ì—ì„œ ì¢‹ì•˜ë˜ ë¶€ë¶„ì€ ë¬´ì—‡ì¸ê°€ìš”?  
        - í™œë™ ì¤‘ì—ì„œ ì–´ë ¤ì› ë˜ ë¶€ë¶„ì€ ë¬´ì—‡ì¸ê°€ìš”?  
        - ì œê°€ ì–´ë–¤ ê²ƒì„ ë” ë„ì™€ë“œë¦¬ë©´ ì¢‹ì„ê¹Œìš”?  

        """,
    }
}

# ìŠ¤í… ìˆœì„œ: ê° State ë‚´ì—ì„œ ì–´ë–¤ ìˆœì„œë¡œ ìŠ¤í…ì„ ì§„í–‰í• ì§€ ê²°ì •
STATE_STEPS_ORDER = {
    ChatbotState.THERAPEUTIC_CONNECTION.value: [
        "rapport_building",
        "goal_and_motivation_building",
        "music_preference",
    ],
    ChatbotState.MUSIC_CREATION.value: [
        "making_concept",
        "making_lyrics",
        "lyrics_gen",
        "lyrics_discussion",
        "making_music",
        "style_gen",
    ],
    ChatbotState.MUSIC_DISCUSSION.value: [
        "music_opinion",
        "music_recreation",
    ],
    ChatbotState.WRAP_UP.value: [
        "reflection",
        "complete",
    ],
}


################################################
# (B) Step ì‹¤í–‰: LLMì´ JSONìœ¼ë¡œ ë³€ìˆ˜ ì¶”ì¶œ
################################################

def generate_question_for_step(llm, state_name: str, step_name: str, context: Dict[str, Any]) -> str:
    """
    1) í•´ë‹¹ Stepì— í•„ìš”í•œ ë³€ìˆ˜ë¥¼ LLMì— ì•ˆë‚´ (ê° ë³€ìˆ˜ë³„ ì„¤ëª… í¬í•¨).
    2) ëŒ€í™” ë‚´ìš©(chat_history)ì„ ë°”íƒ•ìœ¼ë¡œ LLMì´ JSON í˜•íƒœë¡œ ê²°ê³¼ë¥¼ ë°˜í™˜.
    """
    # (1) í•´ë‹¹ ìŠ¤í…ì—ì„œ í•„ìš”í•œ ë³€ìˆ˜ì™€ ê·¸ ì„¤ëª… ê°€ì ¸ì˜¤ê¸°
    var_desc_dict = STEP_VAR_DESCRIPTIONS[state_name][step_name]
    required_vars = list(var_desc_dict.keys())

    # ğŸ”¹ ì´ì „ ìŠ¤í… & ì´ì „ ìŠ¤í…Œì´íŠ¸ë“¤ì˜ ë³€ìˆ˜ ì„¤ëª… ì €ì¥ìš© ë¦¬ìŠ¤íŠ¸
    previous_var_desc = []

    # ğŸ”¹ í˜„ì¬ ìŠ¤í…ì˜ ì´ì „ ìŠ¤í… ë° ì´ì „ ìŠ¤í…Œì´íŠ¸ì˜ ë³€ìˆ˜ ì •ë³´ ìˆ˜ì§‘
    state_keys = list(STATE_STEPS_ORDER.keys())  # ìƒíƒœ(ìŠ¤í…Œì´íŠ¸) ë¦¬ìŠ¤íŠ¸
    current_state_index = state_keys.index(state_name)  # í˜„ì¬ ìƒíƒœì˜ ì¸ë±ìŠ¤
    current_step_index = STATE_STEPS_ORDER[state_name].index(step_name)  # í˜„ì¬ ìŠ¤í…ì˜ ì¸ë±ìŠ¤

    # ğŸ”¹ ì´ì „ ìƒíƒœë“¤(ìŠ¤í…Œì´íŠ¸) ìˆœíšŒ
    for past_state_index in range(current_state_index + 1):  # í˜„ì¬ ìƒíƒœ í¬í•¨ ì´ì „ ìƒíƒœê¹Œì§€
        past_state_name = state_keys[past_state_index]  # ì´ì „ ìƒíƒœ ì´ë¦„
        past_steps = STATE_STEPS_ORDER[past_state_name]  # í•´ë‹¹ ìƒíƒœì˜ ëª¨ë“  ìŠ¤í…
        
        # ğŸ”¹ í˜„ì¬ ìƒíƒœì—ì„œëŠ” í˜„ì¬ ìŠ¤í… ì´ì „ê¹Œì§€ë§Œ ìˆœíšŒ
        max_step_index = current_step_index if past_state_name == state_name else len(past_steps)

        for past_step_index in range(max_step_index):  # ì´ì „ ìŠ¤í…ë“¤ë§Œ ìˆœíšŒ
            past_step_name = past_steps[past_step_index]
            past_var_desc_dict = STEP_VAR_DESCRIPTIONS.get(past_state_name, {}).get(past_step_name, {})
            
            for var, desc in past_var_desc_dict.items():
                previous_var_desc.append(f"- {var}: {desc}")  # ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€

    print("=----------í™”ê¸´---------")
    print(context)
    # (2) í”„ë¡¬í”„íŠ¸ ìƒì„±
    #     - í˜„ì¬ ëŒ€í™” ë‚´ìš©
    #     - í•´ë‹¹ ìŠ¤í…ì˜ ì•ˆë‚´ (STEP_MAIN_PROMPTS)
    #     - ì¶”ì¶œí•´ì•¼ í•  ë³€ìˆ˜ ëª©ë¡ & ì„¤ëª…
    #     - "JSONìœ¼ë¡œë§Œ ì‘ë‹µ" ìš”ì²­
    prompt_text = """
    ë‹¹ì‹ ì€ ì²­ê°ì¥ì• ì¸ì„ ìœ„í•œ ìƒë‹´ ë° ìŒì•…ì¹˜ë£Œ ë³´ì¡° ì±—ë´‡ì…ë‹ˆë‹¤.
    ì²­ê°ì¥ì• ì¸ì€ ë¬¸í•´ë ¥ì´ ë–¨ì–´ì§„ë‹¤ëŠ” ì  ëª…ì‹¬í•˜ì„¸ìš”. 
    ì‚¬ìš©ìì˜ ì´ë¦„ì€ **{user_name}** ì…ë‹ˆë‹¤.

    ë‹¤ìŒì€ í˜„ì¬ê¹Œì§€ì˜ ëŒ€í™” ë‚´ì—­ì…ë‹ˆë‹¤:

    --- ëŒ€í™” ë‚´ì—­ ---
    {chat_history}
    ----------------

    [ì£¼ìš” í”„ë¡¬í”„íŠ¸] 
    {main_prompt}

    [ì¶”ì¶œí•´ì•¼ í•  ë³€ìˆ˜ì™€ ì„¤ëª…]
    {variable_explanations}

    [ëŒ€í™” ê·œì¹™]
    - {user_name}ë‹˜ì´ í¸ì•ˆí•˜ê²Œ ëŒ€í™”í•  ìˆ˜ ìˆë„ë¡ ë°°ë ¤í•˜ì„¸ìš”.
    - {user_name}ë‹˜ì˜ ê´€ì‹¬ê³¼ ê°ì •ì„ ì¡´ì¤‘í•˜ë©° ì§ˆë¬¸í•˜ì„¸ìš”.
    - ì¶”ì¶œí•´ì•¼ í•  ë³€ìˆ˜ë¥¼ ì±„ìš°ëŠ” ê²ƒì„ ìµœìš°ì„ ìœ¼ë¡œ í•˜ë˜ ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€í™”ë¥¼ ì´ì–´ê°€ì„¸ìš”.
    - ë¹„ìŠ·í•˜ê±°ë‚˜ ë˜‘ê°™ì€ ì§ˆë¬¸ì€ ì‚¼ê°€í•˜ì„¸ìš”. 
    - ì‚¬ìš©ìëŠ” ë¬¸í•´ë ¥ì´ ë–¨ì–´ì§€ëŠ” ì²­ê°ì¥ì• ì¸ì´ë¯€ë¡œ ë˜ë„ë¡ ê°„ê²°í•˜ê³  ì§§ì€ ì§ˆë¬¸ì„ ì§„í–‰í•˜ì„¸ìš”. 
    - ì˜ˆì‹œëŠ” ì‚¬ìš©ìê°€ ëª¨ë¥´ê² ë‹¤ê³  í• ë•Œ ì œì‹œí•˜ì„¸ìš”.
    
    [ì¶œë ¥ ê·œì¹™] 
    - ì˜¤ë¡œì§€ ìŠ¤íŠ¸ë§ í˜•ì‹ìœ¼ë¡œë§Œ ì¶œë ¥í•˜ì„¸ìš”. 
    - ì‹œê°„, Bot, assistantë“±ì˜ ì ‘ë‘ì‚¬ë¥¼ ë¶™ì´ì§€ë§ˆì„¸ìš”.
    """

    # (3) LangChain LLMChain ì‹¤í–‰
    prompt = PromptTemplate(
        input_variables=["previous_var","user_name","chat_history","main_prompt","variable_explanations","user_ready", "motivation", "difficulty", "emotion", "music_info", "concept", "lyrics_keyword", "lyrics_sentence","lyrics_flow","lyrics", "discussion_feedback","music_analysis", "music_component","title","style_prompt", "individual_emotion", "strength", "change_music", "change_mind", "feeling"],
        template=prompt_text
    )
    chain = prompt | llm
    output = chain.invoke({
        "user_ready": context.get("user_ready", ""),
        "motivation": context.get("motivation", ""),
        "difficulty": context.get("difficulty", ""),
        "emotion": context.get("emotion", ""),
        "music_info": context.get("music_info", ""),
        "concept": context.get("concept", ""),
        "lyrics_keyword": context.get("lyrics_keyword", ""),
        "lyrics_sentence": context.get("lyrics_sentence", ""),
        "lyrics_flow": context.get("lyrics_flow", ""),
        "lyrics": context.get("lyrics", ""),
        "discussion_feedback": context.get("discussion_feedback", ""),
        "music_analysis": context.get("music_analysis", ""),
        "music_component": context.get("music_component", ""),
        "title": context.get("title", ""),
        "style_prompt": context.get("style_prompt", ""),
        "individual_emotion": context.get("individual_emotion", ""),
        "strength": context.get("strength", ""),
        "change_music": context.get("change_music", ""),
        "change_mind": context.get("change_mind", ""),
        "feeling": context.get("feeling", ""),
        "user_name": context.get("user_name", "Unknown"),
        "chat_history":  context.get("chat_history", "Unknown"),
        "main_prompt": STEP_MAIN_PROMPTS[state_name][step_name],
        "variable_explanations": "\n".join([f"- {var}: {desc}" for var, desc in var_desc_dict.items()]),
        "previous_var": "\n".join(previous_var_desc) if previous_var_desc else "ì´ì „ ë³€ìˆ˜ ì—†ìŒ"


    })  # í”„ë¡¬í”„íŠ¸ì— ë„£ì„ input_variablesê°€ ì—†ìœ¼ë¯€ë¡œ {}ë§Œ ì „ë‹¬


    # # ìµœì¢… í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸°
    # rendered_prompt = prompt.format(
    #     concern= context.get("concern", ""),
    #     motivation= context.get("motivation", ""),
    #     difficulty= context.get("difficulty", ""),
    #     emotion=context.get("emotion", ""),
    #     music_info=context.get("music_info", ""),
    #     concept= context.get("concept", ""),
    #     lyrics_keyword= context.get("lyrics_keyword", ""),
    #     lyrics=context.get("lyrics", ""),
    #     discussion_feedback=context.get("discussion_feedback", ""),
    #     music_component= context.get("music_component", ""),
    #     individual_emotion=context.get("individual_emotion", ""),
    #     strength= context.get("strength", ""),
    #     change_music= context.get("change_music", ""),
    #     change_mind= context.get("change_mind", ""),
    #     feeling= context.get("feeling", ""),
    #     user_name= context.get("user_name", "Unknown"),
    #     chat_history= context.get("chat_history", ""),
    #     main_prompt= STEP_MAIN_PROMPTS[state_name][step_name],
    #     variable_explanations= "\n".join([f"- {var}: {desc}" for var, desc in var_desc_dict.items()])
    # )

    # print("=== ìµœì¢… í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸° ===")
    # print(rendered_prompt)
    # print("================================")

    # new_chat_history = context.get("chat_history", "") + f"\n[System Output - Step: {step_name}]\n{output}"
    # context["chat_history"] = new_chat_history
    return output

def extract_reply_for_step(llm, state_name: str, step_name: str, context: Dict[str, Any], chat_history:str) -> str:

    # (1) í•´ë‹¹ ìŠ¤í…ì—ì„œ í•„ìš”í•œ ë³€ìˆ˜ì™€ ê·¸ ì„¤ëª… ê°€ì ¸ì˜¤ê¸°
    var_desc_dict = STEP_VAR_DESCRIPTIONS[state_name][step_name]
    required_vars = list(var_desc_dict.keys())

    # (2) í”„ë¡¬í”„íŠ¸ ìƒì„±
    #     - í˜„ì¬ ëŒ€í™” ë‚´ìš©
    #     - í•´ë‹¹ ìŠ¤í…ì˜ ì•ˆë‚´ (STEP_MAIN_PROMPTS)
    #     - ì¶”ì¶œí•´ì•¼ í•  ë³€ìˆ˜ ëª©ë¡ & ì„¤ëª…
    #     - "JSONìœ¼ë¡œë§Œ ì‘ë‹µ" ìš”ì²­
    prompt_text = """
    ë‹¹ì‹ ì€ ëŒ€í™”ê¸°ë¡ì„ ë³´ê³  íŠ¹ì • ë³€ìˆ˜ì— ëŒ€ë‹µì„ ê°€ê³µí•´ì„œ ë„£ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
    ì…ë ¥ëœ ëŒ€í™”ê¸°ë¡ë“¤ì„ ë³´ê³  í˜„ì¬ ë‹¨ê³„ì—ì„œ ì±„ì›Œì•¼í•˜ëŠ” ë³€ìˆ˜ì— ë‹µë³€ì„ ì±„ìš°ì„¸ìš”.
    ìµœê·¼ ëŒ€í™”(1~3í„´)ì„ ë³´ê³  íŒë‹¨í•˜ì—¬ ë³€ìˆ˜ë¥¼ ì±„ì›ë‹ˆë‹¤. 

    ë‹¤ìŒì€ í˜„ì¬ê¹Œì§€ì˜ ëŒ€í™” ë‚´ì—­ì…ë‹ˆë‹¤:

    --- ëŒ€í™” ë‚´ì—­ ---
    {chat_history}
    ----------------

    [ì¶”ì¶œí•´ì•¼ í•  ë³€ìˆ˜ì™€ ì„¤ëª…]
    {variable_explanations}

    [ì¶œë ¥ í˜•ì‹ ì•ˆë‚´]
    ìœ„ ëŒ€í™”ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì•„ë˜ì˜ ë³€ìˆ˜ë¥¼ JSON í˜•ì‹ìœ¼ë¡œë§Œ ë°˜í™˜í•˜ì„¸ìš”. 
    ê°€ëŠ¥í•œ ì •ë³´ë¥¼ ìµœëŒ€í•œ ì±„ì›Œì£¼ì„¸ìš”. 
    ë§Œì•½ íŠ¹ì • ë³€ìˆ˜ë¥¼ ì•Œ ìˆ˜ ì—†ë‹¤ë©´ "Unknown" ì´ë¼ê³  ì ì–´ì£¼ì„¸ìš”.
    ì ˆëŒ€ JSON ì´ì™¸ì˜ ë¶ˆí•„ìš”í•œ ë¬¸ì¥ì€ ì“°ì§€ ë§ˆì„¸ìš”.

    ì¶œë ¥ ì˜ˆì‹œ:
    {{
    "ë³€ìˆ˜1": "...",
    "ë³€ìˆ˜2": "...",
    ...
    }}
    """

    # (3) LangChain LLMChain ì‹¤í–‰
    prompt = PromptTemplate(
        input_variables=["chat_history","variable_explanations"],
        template=prompt_text
    )
    chain = prompt | llm
    output = chain.invoke({       
        "chat_history": chat_history,
        "variable_explanations": "\n".join([f"- {var}: {desc}" for var, desc in var_desc_dict.items()])

    })  # í”„ë¡¬í”„íŠ¸ì— ë„£ì„ input_variablesê°€ ì—†ìœ¼ë¯€ë¡œ {}ë§Œ ì „ë‹¬

    # (4) JSON íŒŒì‹± ì‹œë„
    #     - ì œëŒ€ë¡œ JSONì´ ì•„ë‹ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì˜ˆì™¸ì²˜ë¦¬ í•„ìˆ˜
    #     - ì¼ë‹¨ì€ ê°„ë‹¨í•˜ê²Œ try-exceptë¡œ
    try:
        parsed_data = json.loads(output.content)
        # í•„ìš”í•œ ë³€ìˆ˜ contextì— ì €ì¥
        for var in required_vars:
            if var in parsed_data:
                context[var] = parsed_data[var]
            else:
                # JSONì—ì„œ í•´ë‹¹ keyê°€ ì—†ìœ¼ë©´ Unknown ì²˜ë¦¬
                context[var] = "Unknown"
    except json.JSONDecodeError:
        # LLMì´ JSON í˜•ì‹ì„ ì œëŒ€ë¡œ ëª» ë§ì·„ë‹¤ë©´ fallback
        for var in required_vars:
            context[var] = "Unknown"

    # (5) ëŒ€í™” íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸
    #     - ì‹¤ì œë¡œëŠ” ì‚¬ìš©ì ì…ë ¥ë„ ì¶”ê°€í•´ì•¼ í•˜ì§€ë§Œ, ì—¬ê¸°ì„œëŠ” ê°„ë‹¨í™”
    # new_chat_history = context.get("chat_history", "") + f"\n[System Output - Step: {step_name}]\n{output}"
    # context["chat_history"] = new_chat_history
    return output.content

def extract_name_with_llm(llm, user_input: str) -> str:
    """
    LLMì´ ì‚¬ìš©ì ì…ë ¥ì—ì„œ ì´ë¦„ì„ ì¶”ì¶œí•˜ì—¬ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜.
    """
    prompt_text = """
        ì‚¬ìš©ìê°€ ë‹¤ì–‘í•œ ë°©ì‹ìœ¼ë¡œ ìì‹ ì˜ ì´ë¦„ì„ ë§í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 
        ì˜ˆë¥¼ ë“¤ì–´:
        - ë‚˜ëŠ” 00ì´ìš”.
        - ë‚˜ë¥¼ 00ì´ë¼ê³  ë¶ˆëŸ¬ì¤˜.
        - ì œ ì´ë¦„ì€ 00ì…ë‹ˆë‹¤.
        - 00ì´ìš”
        - 00
        - ê¹€00

        ë‹¹ì‹ ì˜ ì—­í• ì€ **ì‚¬ìš©ìì˜ ì…ë ¥ì—ì„œ ì´ë¦„ë§Œ ì •í™•íˆ ì¶”ì¶œ**í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
        ìœ„ì˜ ì‘ë‹µì²˜ëŸ¼ ë“¤ì–´ì˜¤ë©´ ì•„ë˜ì™€ ê°™ì´ ì¶œë ¥í•˜ì„¸ìš”.

        - 00
        
        ì ˆëŒ€ë¡œ ë‹¤ë¥¸ ë¬¸ì¥ì´ë‚˜ ì„¤ëª…ì„ ì¶”ê°€í•˜ì§€ ë§ˆì„¸ìš”.
        í•œê¸€ì´ ê¹¨ì§€ì§€ ì•Šë„ë¡ ê·¸ëŒ€ë¡œ ì¶œë ¥í•´ì£¼ì„¸ìš”. 
        ë°˜ë“œì‹œ ì´ë¦„ë§Œ ê·¸ëŒ€ë¡œ ì¶œë ¥í•˜ì„¸ìš”.


        ì‚¬ìš©ì ì…ë ¥: "{user_input}"
        ì‚¬ìš©ìê°€ ë‹‰ë„¤ì„ì´ë‚˜ ì´ˆì„±ë§Œ ì…ë ¥í–ˆë‹¤ë©´ ê·¸ê²ƒì„ ê·¸ëŒ€ë¡œ ì¶œë ¥í•´ë„ ë©ë‹ˆë‹¤. 
        ì‚¬ìš©ìì˜ ì´ë¦„ì„ ì´í•´ ëª»í–ˆë‹¤ë©´ ì‚¬ìš©ìë¼ê³  ì§€ì¹­í•©ë‹ˆë‹¤. 

        """

    # LangChain LLM ì‹¤í–‰
    prompt = PromptTemplate(input_variables=["user_input"], template=prompt_text)
    chain = prompt | llm
    output = chain.invoke({"user_input": user_input})  # ì‹¤í–‰

    
    name = output.content

    return name if name else "Unknown"
    
def call_suno(title: str, lyrics: str, music_component: str) -> str:
    print(f'lyrics: {lyrics}')
    print(f'meta codes: {music_component}')
    print(f'title: {title}')

    if not os.path.exists('music'):
        os.makedirs('music')
    music_filename = os.path.join("music", f"{title}.wav")

    post = {
        'prompt': lyrics,
        'tags': music_component,
        'title': title,
        'make_instrumental': False,
        'wait_audio': True,
    }
    print(f'post message: {post}')

    response = requests.post('http://localhost:3000/api/custom_generate', json=post)

    if response.status_code == 200:
        res_data = response.json()
        print(res_data)
        audio_url = res_data[0]['audio_url']
        input_lyrics=res_data[0]['lyric']
        print(f'Downlaod music from {audio_url}')
        print(f'ê°€ì‚¬ {input_lyrics}')
        start_time = time.time()
        audio_res = requests.get(audio_url, stream=True, timeout=(5, 300))
        audio_res.raise_for_status()
        with open(music_filename, 'wb') as file:
            for chunk in audio_res.iter_content(chunk_size=8192):
                if chunk:
                    file.write(chunk)
            print(
                f'\nProcessed Suno, Input Text: {lyrics}, Meta_codes: {music_component}, Title: {title}, Output Music: {music_filename}.')
        print(f'Download done! Elapsed Time: {time.time() - start_time}')
    else:
        print(f'error code: {response.status_code}, message: {response.content}')

    return music_filename

def save_chat_history(context, user_name):
    """ëŒ€í™” ê¸°ë¡ì„ 'chat_history_YYYY-MM-DD_HH-MM-SS.txt' í˜•ì‹ìœ¼ë¡œ ì €ì¥"""
    timestamp = datetime.datetime.now().strftime("%Y-%m-%d_%H-%M-%S")
    filename = f"chat_history_{timestamp}_{user_name}.txt"
    
    # í´ë” ì¡´ì¬ ì—¬ë¶€ í™•ì¸ í›„ ìƒì„±
    if not os.path.exists("chat_logs"):
        os.makedirs("chat_logs")

    file_path = os.path.join("chat_logs", filename)
    
    with open(file_path, "w", encoding="utf-8") as file:
        file.write(context["chat_history"])
    
    print(f"ëŒ€í™” ê¸°ë¡ì´ '{file_path}' íŒŒì¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
